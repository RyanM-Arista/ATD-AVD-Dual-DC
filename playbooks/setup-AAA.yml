---

- name: Setup AAA for ATD
  hosts: ATD_CVP
  connection: local
  gather_facts: no
  vars_prompt:

      - name: ansible_user
        prompt: What is your username?
        private: no

      - name: ansible_password
        prompt: What is your lab password?
        #encrypt: sha512_crypt
        confirm: yes

  vars:
    sha512_password: "{{ ansible_password | password_hash('sha512') }}"

  tasks:
    - name: "Gather CVP facts {{inventory_hostname}}"
      arista.cvp.cv_facts:
        facts:
          configlets
      register: CVP_FACTS

    # - name: 'Display cv_configlet result'
    #   debug:
    #     msg: '{{CVP_FACTS.ansible_facts.configlets | selectattr("name", "==", "ATD-INFRA") | map(attribute="config") | join(" ") | regex_findall("username .*") }}'

    - name: Create AAA template
      template:
        src: "{{lookup('env','PWD')}}/roles/templates/AAA.j2"
        dest: "{{lookup('env','PWD')}}/group_vars/ATD_FABRIC/AAA.yml"
      vars:
         AAA: '{{CVP_FACTS.ansible_facts.configlets | selectattr("name", "==", "ATD-INFRA") | map(attribute="config") | join(" ") | regex_findall("username .*") }}'

    - name: Add CVP credentials
      template:
        src: "{{lookup('env','PWD')}}/roles/templates/CVP_CRED.j2"
        dest: "{{lookup('env','PWD')}}/group_vars/CVP/CVP_CRED.yml"